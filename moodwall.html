<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¯æ—¥å¿ƒæƒ…å¡ç‰‡ç‰† â€” å¾©å¤æ‰“å­—æ©Ÿï¼ˆæµ®æ°´å°ä¿®å¾©ç‰ˆï¼‰</title>
  <style>
    :root {
      --typewriter-width: 380px;
      --card-width: 320px;
      --card-height: 410px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: "Noto Sans TC", "Roboto Mono", monospace, system-ui;
      background: linear-gradient(180deg, #f7f7f7 0%, #efeae0 100%);
      overflow: hidden;
    }

    /* 1. å¿ƒæƒ…ç‰†ï¼šå…¨è¢å¹• */
    #mood-wall {
      position: absolute;
      inset: 0;
      background:
        linear-gradient(rgba(0, 0, 0, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 0, 0, 0.02) 1px, transparent 1px),
        #e9ddc9;
      background-size: 60px 60px, 60px 60px, cover;
      padding: 20px;
      overflow: auto;
      z-index: 1;
    }

    /* å¡ç‰‡å±¤ */
    .cards-layer {
      position: relative;
      width: 100%;
      height: 100%;
      pointer-events: auto;
    }

    /* 2. æ‰“å­—æ©Ÿå®¹å™¨ */
    .typewriter-container {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: var(--typewriter-width);
      z-index: 60;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
    }

    /* æ©Ÿèº«å¯¦é«” */
    .typewriter-body {
      pointer-events: auto;
      width: 100%;
      background: #2c2c2c;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
      padding: 12px;
      position: relative;
      color: #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* æ»¾ç­’å€ */
    .roller-area {
      position: relative;
      width: 100%;
      height: 30px;
      margin-bottom: -15px;
      z-index: 5;
    }

    .carriage {
      position: absolute;
      top: 0;
      left: 5%;
      width: 90%;
      height: 30px;
      background: #444;
      border-radius: 4px;
      border: 1px solid #555;
    }

    .lever {
      position: absolute;
      top: -20px;
      right: -10px;
      width: 8px;
      height: 50px;
      background: #d9534f;
      transform: rotate(15deg);
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }

    .lever:active {
      transform: rotate(5deg) translateY(5px);
    }

    /* ç´™å¼µ (è¼¸å…¥å€) */
    .paper {
      position: relative;
      width: 94%;
      height: 110px;
      background-color: #F9F7F3;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      line-height: 1.5;
      color: #222;
      overflow-y: auto;
      border-radius: 2px;
      margin: 0 auto;
      z-index: 4;
      cursor: text;
    }

    .paper p {
      white-space: pre-wrap;
      margin: 0;
      color: #2b2b2b;
      font-size: 14px;
      min-height: 20px;
      font-weight: 500;
    }

    .paper-controls {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .pctrl-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    /* æ§åˆ¶åˆ— */
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #3a3a3a;
      padding: 8px 10px;
      border-radius: 8px;
      margin-top: 5px;
      z-index: 10;
    }

    /* å¿ƒæƒ…æŒ‰éˆ• */
    .mood-group {
      display: flex;
      gap: 4px;
    }

    .mood-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eee;
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.1s;
      color: #333;
    }

    .mood-btn:hover {
      transform: scale(1.1);
    }

    .mood-btn.active {
      background: #fffbe6;
      border-color: #ffd700;
      transform: translateY(-2px);
      box-shadow: 0 0 8px #ffd700;
    }

    /* åˆ—å°æŒ‰éˆ• */
    .print-btn {
      background: #d9534f;
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      box-shadow: 0 3px 0 #a94442;
    }

    .print-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }

    /* é¢¨æ ¼é¸æ“‡ */
    .style-select select {
      background: #eee;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 13px;
      color: #333;
      font-weight: bold;
    }

    /* éµç›¤å€ */
    .keyboard-base {
      background: #4A4A4A;
      padding: 10px 5px 15px;
      border-radius: 6px;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
      margin-top: 2px;
    }

    .key,
    .space-bar {
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #333;
      background: #EAE0D5;
      box-shadow: 0 3px 0 #8d857c;
      cursor: pointer;
      user-select: none;
      transition: transform 0.05s;
    }

    .key.pressed {
      transform: translateY(3px);
      box-shadow: 0 0 0;
      background: #dacdc0;
    }

    .space-bar {
      grid-column: span 6;
      background: #c0c0c0;
    }

    /* ======== å¡ç‰‡æ¨£å¼ ======== */
    .card {
      width: var(--card-width);
      height: var(--card-height);
      background: #fff;
      position: absolute;
      user-select: none;
      transition: transform 0.1s;
      padding: 14px 14px 55px 14px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card .photo {
      width: 100%;
      height: 260px;
      background: #f0f0f0;
      overflow: hidden;
      display: flex;

      function blobToDataURL(blob){
      return new Promise(res=> {
          const fr=new FileReader(); fr.onload=()=> res(fr.result); fr.readAsDataURL(blob);
        });
    }

    function splitBase64(str, n) {
      const len=Math.ceil(str.length / n);
      const arr=[];
      for (let i=0; i < n; i++) arr.push(str.slice(i * len, (i + 1) * len));
      return arr;
    }

    /* Printing */
    printBtn.addEventListener('click', ()=> {
        const text=hiddenInput.value.trim();
        const existingCards=document.querySelectorAll('.card:not(.printing)');

        if (existingCards.length >=MAX_CARDS) {
          alert(`å¿ƒæƒ…ç‰†å·²æ»¿ ($ {
                MAX_CARDS
              }

              å¼µ)ï¼è«‹å…ˆåˆªé™¤èˆŠå¡ç‰‡ã€‚`); return;
        }

        if ( !text && !currentBase64Parts) {
          alert('è«‹å¯«é»æ±è¥¿æˆ–ä¸Šå‚³åœ–ç‰‡'); focusInput(); return;
        }

        const cardId='card_' + Date.now();
        const cardEl=document.createElement('div');

        cardEl.className=`card $ {
          currentStyle
        }

        printing`;
        cardEl.dataset.cardId=cardId;

        let imgHtml='';

        if (currentBase64Parts) {
          const fullSrc=currentBase64Parts.header + currentBase64Parts.parts.join('');
          imgHtml=`<img src="${fullSrc}" >`;
        }

        else {
          imgHtml=window.PRESET_SVGS[Math.floor(Math.random() * window.PRESET_SVGS.length)];
        }

        const moodIcons=['', 'ğŸ˜«', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];

        cardEl.innerHTML=` <div class="delete-btn" title="åˆªé™¤" >Ã—</div> <div class="photo" >$ {
          imgHtml
        }

        </div> <div class="text" >$ {
          text
        }

        </div> <div class="mood-badge" >$ {
          moodIcons[currentMood] || ''
        }

        </div> `;

        const tx=Math.random() * (window.innerWidth - 340) + 20;
        const ty=Math.random() * (window.innerHeight - 500) + 20;
        const rot=Math.random() * 10 - 5;

        cardsLayer.appendChild(cardEl);

        setTimeout(()=> {
            cardEl.classList.remove('printing');
            cardEl.style.left=tx + 'px';
            cardEl.style.top=ty + 'px';

            cardEl.style.transform=`rotate($ {
                rot
              }

              deg)`;

            saveCard({
              id: cardId, text, mood: currentMood, style: currentStyle,
              parts: currentBase64Parts ? currentBase64Parts.parts : null,
              header: currentBase64Parts ? currentBase64Parts.header : null,
              x: parseFloat(tx), y: parseFloat(ty), r: rot
            });
          currentBase64Parts=null;
        }

        , 2500);

      bindCardEvents(cardEl);
      hiddenInput.value=''; hiddenInput.dispatchEvent(new Event('input')); focusInput();
    });

    function bindCardEvents(el) {
      const del=el.querySelector('.delete-btn');

      del.addEventListener('click', (e)=> {
          e.stopPropagation();

          if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ')) {
            el.remove(); deleteCard(el.dataset.cardId);
          }
        });
      makeDraggable(el);
    }

    function makeDraggable(el) {
      let isDown=false,
      offX,
      offY;

      el.addEventListener('mousedown', e=> {
          if (e.target.classList.contains('delete-btn')) return;
          isDown=true; offX=e.clientX - el.offsetLeft; offY=e.clientY - el.offsetTop;
          el.style.zIndex=1000; el.style.transition='none';
        });

      window.addEventListener('mousemove', e=> {
          if ( !isDown) return; el.style.left=(e.clientX - offX) + 'px'; el.style.top=(e.clientY - offY) + 'px';
        });

      window.addEventListener('mouseup', ()=> {
          if (isDown) {
            isDown=false;
            el.style.zIndex='';
            el.style.transition='transform 0.1s';
            // Extract rotation from transform
            const match=el.style.transform.match(/rotate\((.*?)deg\)/);
            const r=match ? parseFloat(match[1]) : 0;
            updateCardPos(el.dataset.cardId, el.style.left, el.style.top, r);
          }
        });
    }

    /* API Integration */
    async function saveCard(meta) {
      try {
        await fetch(API_URL, {

          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }

          ,
          body: JSON.stringify(meta)
        });
    }

    catch (e) {
      console.error('Save failed', e);
      alert('å„²å­˜å¤±æ•—');
    }
    }

    async function deleteCard(id) {
      try {
        await fetch(`$ {
            API_URL
          }

          /$ {
            id
          }

          `, {
          method: 'DELETE'
        });
    }

    catch (e) {
      console.error('Delete failed', e);
    }
    }

    async function updateCardPos(id, x, y, r) {
      try {
        await fetch(`$ {
            API_URL
          }

          /$ {
            id
          }

          `, {

          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          }

          ,
          body: JSON.stringify({
            x: parseFloat(x),
            y: parseFloat(y),
            r: parseFloat(r)
          })
      });
    }

    catch (e) {
      console.error('Update pos failed', e);
    }
    }

    async function loadCards() {
      try {
        const res=await fetch(API_URL);
        const list=await res.json();

        list.forEach(d=> {
            const el=document.createElement('div');

            el.className=`card $ {
              d.style || 'polaroid'
            }

            `;
            el.dataset.cardId=d.id;

            el.style.left=d.x + 'px'; el.style.top=d.y + 'px'; el.style.transform=`rotate($ {
                d.r
              }

              deg)`;

            let imgHtml='';

            if (d.parts && d.header) {
              imgHtml=`<img src="${d.header}${d.parts.join('')}" >`;
            }

            else {
              imgHtml=window.PRESET_SVGS[Math.floor(Math.random() * window.PRESET_SVGS.length)];
            }

            const moodIcons=['', 'ğŸ˜«', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];

            el.innerHTML=` <div class="delete-btn" >Ã—</div> <div class="photo" >$ {
              imgHtml
            }

            </div> <div class="text" >$ {
              d.text
            }

            </div> <div class="mood-badge" >$ {
              moodIcons[d.mood] || ''
            }

            </div> `;
            cardsLayer.appendChild(el); bindCardEvents(el);
          });
      }

      catch (e) {
        console.error('Load failed', e);
      }
    }

    window.PRESET_SVGS=[ `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#eef"><circle cx="50" cy="50" r="30" fill="#fbbf24" /></svg>`,
    `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#f0fdf4"><rect x="30" y="30" width="40" height="40" fill="#4ade80" /></svg>`,
    `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#fff7ed"><polygon points="50,15 90,85 10,85" fill="#f87171" /></svg>`];
    </script></body></html>