<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¯æ—¥å¿ƒæƒ…å¡ç‰‡ç‰†</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --typewriter-width: 380px;
      --card-width: 320px;
      --card-height: 410px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: "Noto Sans TC", "Roboto Mono", monospace, system-ui;
      background: linear-gradient(180deg, #f7f7f7 0%, #efeae0 100%);
      overflow: hidden;
    }

    /* 1. å¿ƒæƒ…ç‰†ï¼šå…¨è¢å¹• */
    #mood-wall {
      position: absolute;
      inset: 0;
      background:
        linear-gradient(rgba(0, 0, 0, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 0, 0, 0.02) 1px, transparent 1px),
        #e9ddc9;
      background-size: 60px 60px, 60px 60px, cover;
      padding: 20px;
      overflow: auto;
    }

    /* å¡ç‰‡å±¤ */
    .cards-layer {
      position: relative;
      width: 100%;
      height: 100%;
      pointer-events: auto;
    }

    /* 2. æ‰“å­—æ©Ÿå®¹å™¨ */
    .typewriter-container {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: var(--typewriter-width);
      z-index: 60;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      transform-origin: bottom center;
      transition: transform 0.2s;
    }

    /* æ©Ÿèº«å¯¦é«” */
    .typewriter-body {
      pointer-events: auto;
      width: 100%;
      background: #2c2c2c;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
      padding: 12px;
      position: relative;
      color: #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* æ»¾ç­’å€ */
    .roller-area {
      position: relative;
      width: 100%;
      height: 30px;
      margin-bottom: -15px;
      z-index: 5;
    }

    .carriage {
      position: absolute;
      top: 0;
      left: 5%;
      width: 90%;
      height: 30px;
      background: #444;
      border-radius: 4px;
      border: 1px solid #555;
    }

    .lever {
      position: absolute;
      top: -20px;
      right: -10px;
      width: 8px;
      height: 50px;
      background: #d9534f;
      transform: rotate(15deg);
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }

    .lever:active {
      transform: rotate(5deg) translateY(5px);
    }

    /* ç´™å¼µ (è¼¸å…¥å€) */
    .paper {
      position: relative;
      width: 94%;
      height: 110px;
      background-color: #F9F7F3;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      line-height: 1.5;
      color: #222;
      overflow-y: auto;
      border-radius: 2px;
      margin: 0 auto;
      z-index: 4;
      cursor: text;
    }

    .paper p {
      white-space: pre-wrap;
      margin: 0;
      color: #2b2b2b;
      font-size: 14px;
      min-height: 20px;
      font-weight: 500;
    }

    .paper-controls {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .pctrl-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    /* æ§åˆ¶åˆ— */
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #3a3a3a;
      padding: 8px 10px;
      border-radius: 8px;
      margin-top: 5px;
      z-index: 10;
    }

    /* å¿ƒæƒ…æŒ‰éˆ• */
    .mood-group {
      display: flex;
      gap: 4px;
    }

    .mood-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eee;
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.1s;
      color: #333;
    }

    .mood-btn:hover {
      transform: scale(1.1);
    }

    .mood-btn.active {
      background: #fffbe6;
      border-color: #ffd700;
      transform: translateY(-2px);
      box-shadow: 0 0 8px #ffd700;
    }

    /* åˆ—å°æŒ‰éˆ• */
    .print-btn {
      background: #d9534f;
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      box-shadow: 0 3px 0 #a94442;
    }

    .print-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }

    /* é¢¨æ ¼é¸æ“‡ */
    .style-select select {
      background: #eee;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 13px;
      color: #333;
      font-weight: bold;
    }

    /* éµç›¤å€ */
    .keyboard-base {
      background: #4A4A4A;
      padding: 10px 5px 15px;
      border-radius: 6px;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
      margin-top: 2px;
    }

    .key,
    .space-bar {
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #333;
      background: #EAE0D5;
      box-shadow: 0 3px 0 #8d857c;
      cursor: pointer;
      user-select: none;
      transition: transform 0.05s;
    }

    .key.pressed {
      transform: translateY(3px);
      box-shadow: 0 0 0;
      background: #dacdc0;
    }

    .space-bar {
      grid-column: span 6;
      background: #c0c0c0;
    }

    /* ======== å¡ç‰‡æ¨£å¼ ======== */
    .card {
      width: var(--card-width);
      height: var(--card-height);
      background: #fff;
      position: absolute;
      user-select: none;
      transition: transform 0.1s;
      padding: 14px 14px 55px 14px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card .photo {
      width: 100%;
      height: 260px;
      background: #f0f0f0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #eee;
    }

    .card .photo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* ä¿®æ­£ï¼šå®Œæ•´é¡¯ç¤ºä¸è£åˆ‡ */
      background: #000;
      /* ä¿®æ­£ï¼šé»‘åº•è£œé‚Š */
    }

    .card .text {
      width: 100%;
      padding: 12px 4px 0;
      font-size: 15px;
      white-space: pre-wrap;
      color: #333;
      font-family: 'Courier New', Courier, monospace;
      overflow: hidden;
      flex: 1;
    }

    .card .mood-badge {
      position: absolute;
      bottom: 12px;
      right: 15px;
      font-size: 28px;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .card .delete-btn {
      position: absolute;
      top: -12px;
      left: -12px;
      background: #ff4444;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 100;
      font-size: 18px;
      line-height: 1;
    }

    .card .save-btn {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #4CAF50;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 100;
      font-size: 16px;
      line-height: 1;
    }

    /* Expanded Card Style - Responsive Scale */
    .card.expanded {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(1.5) !important;
      /* Desktop default: 1.5x */
      z-index: 10001 !important;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
      cursor: default;
    }

    /* Overlay for expanded mode */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    #overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* åˆ—å°å‹•ç•« */
    @keyframes slow-print {
      0% {
        opacity: 0;
        transform: translate(-50%, 100px) scale(0.9);
        filter: blur(2px);
      }

      30% {
        opacity: 1;
        transform: translate(-50%, -150px) scale(0.95);
        filter: blur(0);
      }

      100% {
        opacity: 1;
        transform: translate(-50%, -300px) rotate(-3deg) scale(1);
      }
    }

    .card.printing {
      position: fixed;
      left: 50% !important;
      bottom: 50px !important;
      top: auto !important;
      transform-origin: center bottom;
      animation: slow-print 2.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      z-index: 1000;
      pointer-events: none;
    }

    /* éš±è—è¼¸å…¥æ¡† */
    #hidden-input {
      position: absolute;
      opacity: 0;
      top: 0;
      left: 0;
      height: 0;
      width: 0;
      border: none;
      padding: 0;
    }

    /* RWD */
    @media (max-width: 768px) {
      :root {
        --typewriter-width: 100%;
        --card-width: 260px;
        --card-height: 340px;
      }

      /* Mobile expanded scale */
      .card.expanded {
        transform: translate(-50%, -50%) scale(1.1) !important;
      }

      .keyboard-base .key {
        height: 38px;
        font-size: 11px;
      }

      .controls-row {
        padding: 6px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .mood-btn {
        width: 26px;
        height: 26px;
      }

      .typewriter-container {
        width: 100%;
        padding: 0 10px;
      }

      .paper {
        height: 90px;
      }
    }
  </style>
</head>

<body>

  <div id="mood-wall" aria-label="å¿ƒæƒ…ç‰†">
    <div id="overlay"></div>
    <div class="cards-layer" id="cards-layer"></div>
  </div>

  <div class="typewriter-container" role="region" aria-label="æ‰“å­—æ©Ÿ">
    <div class="typewriter-body" id="typewriter-body">

      <div class="roller-area">
        <div class="carriage"></div>
        <div class="lever"></div>
      </div>

      <div class="paper" id="paper">
        <div class="paper-controls">
          <button class="pctrl-btn" id="btn-upload" title="ä¸Šå‚³åœ–ç‰‡">ğŸ“· ä¸Šå‚³</button>
        </div>
        <p id="typed-text">é»æ­¤è¼¸å…¥å¿ƒæƒ…...</p>
        <textarea id="hidden-input"></textarea>
      </div>

      <div class="controls-row">
        <div class="style-select">
          <select id="card-style">
            <option value="polaroid" selected>æ‹ç«‹å¾—</option>
            <option value="postcard">æ˜ä¿¡ç‰‡</option>
            <option value="minimal">æ¥µç°¡</option>
            <option value="sticker">è²¼ç´™</option>
          </select>
        </div>

        <button class="print-btn" id="print-btn">ğŸ–¨ï¸ å°å‡ºå¡ç‰‡</button>

        <div class="mood-group">
          <div class="mood-btn" data-mood="1">ğŸ˜«</div>
          <div class="mood-btn" data-mood="2">ğŸ™</div>
          <div class="mood-btn active" data-mood="3">ğŸ˜</div>
          <div class="mood-btn" data-mood="4">ğŸ™‚</div>
          <div class="mood-btn" data-mood="5">ğŸ˜„</div>
        </div>
      </div>

      <div class="keyboard-base" aria-hidden="true">
        <div class="key" data-key="q">Q</div>
        <div class="key" data-key="w">W</div>
        <div class="key" data-key="e">E</div>
        <div class="key" data-key="r">R</div>
        <div class="key" data-key="t">T</div>
        <div class="key" data-key="y">Y</div>
        <div class="key" data-key="u">U</div>
        <div class="key" data-key="i">I</div>
        <div class="key" data-key="o">O</div>
        <div class="key" data-key="p">P</div>
        <div class="key" style="margin-left:5%" data-key="a">A</div>
        <div class="key" data-key="s">S</div>
        <div class="key" data-key="d">D</div>
        <div class="key" data-key="f">F</div>
        <div class="key" data-key="g">G</div>
        <div class="key" data-key="h">H</div>
        <div class="key" data-key="j">J</div>
        <div class="key" data-key="k">K</div>
        <div class="key" data-key="l">L</div>
        <div class="key" data-key="Backspace">âŒ«</div>
        <div class="key" style="margin-left:10%" data-key="z">Z</div>
        <div class="key" data-key="x">X</div>
        <div class="key" data-key="c">C</div>
        <div class="key" data-key="v">V</div>
        <div class="key" data-key="b">B</div>
        <div class="key" data-key="n">N</div>
        <div class="key" data-key="m">M</div>
        <div class="key" data-key=",">,</div>
        <div class="key" data-key=".">.</div>
        <div class="key return-key" data-key="Enter">Enter</div>
        <div class="space-bar" data-key=" ">SPACE</div>
      </div>
    </div>
  </div>

  <input id="file-input" type="file" accept="image/*" style="display:none" />

  <script>
    /* ä¿®å¾©ç‰ˆï¼šå¢åŠ æµ®æ°´å°æé‚Šèˆ‡é‚Šè· */

    const MAX_CARDS = 7;
    const TARGET_IMAGE_MAX_BYTES = 100 * 1024;
    const API_URL = 'http://localhost:3000/api/cards';

    /* UI Elements */
    const typedText = document.getElementById('typed-text');
    const hiddenInput = document.getElementById('hidden-input');
    const paperDiv = document.getElementById('paper');
    const fileInput = document.getElementById('file-input');
    const btnUpload = document.getElementById('btn-upload');
    const printBtn = document.getElementById('print-btn');
    const cardsLayer = document.getElementById('cards-layer');
    const moodButtons = document.querySelectorAll('.mood-btn');
    const styleSelect = document.getElementById('card-style');
    const overlay = document.getElementById('overlay');
    const typewriterContainer = document.querySelector('.typewriter-container');

    let currentMood = 3;
    let currentStyle = 'polaroid';
    let currentBase64Parts = null;

    /* Init & Focus */
    window.onload = () => {
      loadCards();
      focusInput();
      adjustLayout();
    };
    window.onresize = adjustLayout;

    function adjustLayout() {
      const w = window.innerWidth;
      // Base width for typewriter is around 380px. 
      // Scale down more aggressively for mobile to save space
      // User requested ~40% smaller than previous.
      // Previous Desktop: 0.8 -> New: 0.5
      // Previous Mobile: (w-20)/380 -> New: (w-20)/380 * 0.6
      let scale = 0.5;
      if (w < 420) {
        scale = ((w - 20) / 380) * 0.6;
      }
      typewriterContainer.style.transform = `translateX(-50%) scale(${scale})`;
    }

    function focusInput() { hiddenInput.focus(); }
    paperDiv.addEventListener('click', focusInput);

    // Click background to restore
    overlay.addEventListener('click', () => {
      document.querySelectorAll('.card.expanded').forEach(c => c.classList.remove('expanded'));
      overlay.classList.remove('active');
    });

    document.querySelector('.keyboard-base').addEventListener('click', (e) => {
      focusInput();
      const keyEl = e.target.closest('.key, .space-bar');
      if (keyEl) {
        const key = keyEl.dataset.key;
        visualKeyPress(key);
        if (key === 'Backspace') hiddenInput.value = hiddenInput.value.slice(0, -1);
        else if (key === 'Enter') hiddenInput.value += '\n';
        else if (key === 'Space') hiddenInput.value += ' ';
        else if (key.length === 1) hiddenInput.value += key;
        hiddenInput.dispatchEvent(new Event('input'));
      }
    });

    /* Keyboard Listener */
    document.addEventListener('keydown', (e) => {
      if (e.isComposing) return;
      focusInput();
      visualKeyPress(e.key);
    });
    function visualKeyPress(keyStr) {
      let selector = `[data-key="${keyStr}"]`;
      if (keyStr === ' ') selector = `[data-key=" "]`;
      else if (keyStr.toLowerCase) selector = `[data-key="${keyStr.toLowerCase()}"]`;
      const el = document.querySelector(selector);
      if (el) { el.classList.add('pressed'); setTimeout(() => el.classList.remove('pressed'), 100); }
    }

    /* Input Sync with Limits */
    hiddenInput.addEventListener('input', () => {
      let val = hiddenInput.value;
      const lines = val.split('\n');
      const MAX_LINES = 9;
      const MAX_CHARS_PER_LINE = 14; // Approximate for typewriter width

      // Enforce line count
      if (lines.length > MAX_LINES) {
        val = lines.slice(0, MAX_LINES).join('\n');
      }

      // Enforce line length (simple truncation)
      const truncatedLines = val.split('\n').map(line => {
        return line.length > MAX_CHARS_PER_LINE ? line.slice(0, MAX_CHARS_PER_LINE) : line;
      });
      val = truncatedLines.join('\n');

      if (hiddenInput.value !== val) {
        hiddenInput.value = val;
      }

      typedText.textContent = val;
      if (!val) typedText.innerHTML = '<span style="color:#999">é»æ­¤è¼¸å…¥å¿ƒæƒ…...</span>';
      else typedText.style.color = '#2b2b2b';
    });

    /* Mood & Style */
    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        moodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMood = Number(btn.dataset.mood);
      });
    });
    styleSelect.addEventListener('change', (e) => currentStyle = e.target.value);

    /* Image Processing with Improved Watermark */
    btnUpload.addEventListener('click', (e) => { e.stopPropagation(); fileInput.click(); });
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const originalText = btnUpload.textContent;
      btnUpload.textContent = 'è™•ç†ä¸­...';
      try {
        const processed = await processImageFileSpecV2(f, TARGET_IMAGE_MAX_BYTES);
        currentBase64Parts = processed;
        btnUpload.textContent = 'âœ… å·²å°±ç·’';
        setTimeout(() => btnUpload.textContent = originalText, 2000);
        focusInput();
      } catch (err) {
        alert('åœ–ç‰‡è™•ç†å¤±æ•—: ' + err.message);
        btnUpload.textContent = originalText;
      }
      fileInput.value = '';
    });

    async function processImageFileSpecV2(file, targetMaxBytes) {
      const img = await createImageBitmap(file);
      const MAX_DIM = 1200;
      let w = img.width, h = img.height;
      if (Math.max(w, h) > MAX_DIM) {
        const ratio = MAX_DIM / Math.max(w, h);
        w = Math.round(w * ratio); h = Math.round(h * ratio);
      }
      let quality = 0.9;
      let blob = await drawAndWatermark(img, w, h, quality);
      while (blob.size > targetMaxBytes && quality >= 0.5) {
        quality -= 0.1;
        blob = await drawAndWatermark(img, w, h, quality);
      }
      if (blob.size > targetMaxBytes) throw new Error('åœ–ç‰‡éå¤§ç„¡æ³•å£“ç¸®');
      const dataUrl = await blobToDataURL(blob);
      const idx = dataUrl.indexOf('base64,');
      const header = dataUrl.slice(0, idx + 7);
      const b64Body = dataUrl.slice(idx + 7);
      const parts = splitBase64(b64Body, 3);
      return { mime: blob.type, parts: parts, header: header, sizeBytes: blob.size };
    }

    /* ä¿®æ­£å¾Œçš„æµ®æ°´å°ç¹ªè£½ï¼šå¢åŠ æé‚Šèˆ‡é‚Šè· */
    function drawAndWatermark(imgBitmap, w, h, q) {
      return new Promise(resolve => {
        const cvs = document.createElement('canvas');
        cvs.width = w; cvs.height = h;
        const ctx = cvs.getContext('2d');
        ctx.drawImage(imgBitmap, 0, 0, w, h);

        // Fix: Use local time
        const now = new Date();
        const ts = now.getFullYear() + '-' +
          (now.getMonth() + 1).toString().padStart(2, '0') + '-' +
          now.getDate().toString().padStart(2, '0') + ' ' +
          now.getHours().toString().padStart(2, '0') + ':' +
          now.getMinutes().toString().padStart(2, '0');

        // å­—é«”å¤§å°ï¼šè‡³å°‘20pxï¼Œæˆ–æ ¹æ“šå¯¬åº¦èª¿æ•´
        const fontSize = Math.max(20, Math.round(w * 0.035));
        ctx.font = `bold ${fontSize}px "Courier New", monospace`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';

        // ä¿®æ­£ï¼šå¢åŠ æé‚Š (Stroke) ä»¥ç¢ºä¿å¯è¦–æ€§
        ctx.strokeStyle = 'rgba(0,0,0,0.8)'; // åŠ æ·±æé‚Š
        ctx.lineWidth = Math.max(3, fontSize * 0.2); // åŠ ç²—æé‚Š
        // å¢åŠ é‚Šè·è‡³ w-20, h-20ï¼Œé¿å…è²¼é‚Š
        ctx.strokeText(ts, w - 20, h - 20);

        ctx.fillStyle = '#ffffff';
        ctx.fillText(ts, w - 20, h - 20);

        cvs.toBlob(b => resolve(b), 'image/jpeg', q);
      });
    }

    function blobToDataURL(blob) { return new Promise(res => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(blob); }); }
    function splitBase64(str, n) { const len = Math.ceil(str.length / n); const arr = []; for (let i = 0; i < n; i++) arr.push(str.slice(i * len, (i + 1) * len)); return arr; }

    /* Printing */
    printBtn.addEventListener('click', () => {
      const text = hiddenInput.value.trim();
      // Fix: Count ALL cards to strictly enforce limit
      const existingCards = document.querySelectorAll('.card');
      if (existingCards.length >= MAX_CARDS) { alert(`å¿ƒæƒ…ç‰†å·²æ»¿ (${MAX_CARDS}å¼µ)ï¼è«‹å…ˆåˆªé™¤èˆŠå¡ç‰‡ã€‚`); return; }
      if (!text && !currentBase64Parts) { alert('è«‹å¯«é»æ±è¥¿æˆ–ä¸Šå‚³åœ–ç‰‡'); focusInput(); return; }

      const cardId = 'card_' + Date.now();
      const cardEl = document.createElement('div');
      cardEl.className = `card ${currentStyle} printing`;
      cardEl.dataset.cardId = cardId;

      let imgHtml = '';
      if (currentBase64Parts) {
        const fullSrc = currentBase64Parts.header + currentBase64Parts.parts.join('');
        imgHtml = `<img src="${fullSrc}">`;
      } else {
        imgHtml = window.PRESET_SVGS[Math.floor(Math.random() * window.PRESET_SVGS.length)];
      }

      const moodIcons = ['', 'ğŸ˜«', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
      cardEl.innerHTML = `
        <div class="delete-btn" title="åˆªé™¤">Ã—</div>
        <div class="save-btn" title="ä¸‹è¼‰">â¬‡</div>
        <div class="photo">${imgHtml}</div>
        <div class="text">${text}</div>
        <div class="mood-badge">${moodIcons[d.mood] || ''}</div>
    `;

      const tx = Math.random() * (window.innerWidth - 340) + 20;
      const ty = Math.random() * (window.innerHeight - 500) + 20;
      const rot = Math.random() * 10 - 5;

      cardsLayer.appendChild(cardEl);

      setTimeout(() => {
        cardEl.classList.remove('printing');
        cardEl.style.left = tx + 'px';
        cardEl.style.top = ty + 'px';
        cardEl.style.transform = `rotate(${rot}deg) scale(0.3)`; // Default small scale

        saveCard({
          id: cardId, text, mood: currentMood, style: currentStyle,
          parts: currentBase64Parts ? currentBase64Parts.parts : null,
          header: currentBase64Parts ? currentBase64Parts.header : null,
          x: parseFloat(tx), y: parseFloat(ty), r: rot
        });
        currentBase64Parts = null;
      }, 2500);

      bindCardEvents(cardEl);
      hiddenInput.value = ''; hiddenInput.dispatchEvent(new Event('input')); focusInput();
    });

    function bindCardEvents(el) {
      const del = el.querySelector('.delete-btn');
      del.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ')) {
          el.remove();
          deleteCard(el.dataset.cardId);
          if (overlay.classList.contains('active')) overlay.classList.remove('active');
        }
      });

      const save = el.querySelector('.save-btn');
      if (save) {
        save.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadCard(el);
        });
      }

      // Double click to expand
      el.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        // Close others
        document.querySelectorAll('.card.expanded').forEach(c => c.classList.remove('expanded'));

        el.classList.add('expanded');
        overlay.classList.add('active');
      });

      makeDraggable(el);
    }

    function makeDraggable(el) {
      let isDown = false, offX, offY;
      el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('delete-btn') || e.target.classList.contains('save-btn')) return;
        // Fix: Prevent default drag behavior on images to avoid sticking
        if (e.target.tagName === 'IMG') e.preventDefault();

        isDown = true; offX = e.clientX - el.offsetLeft; offY = e.clientY - el.offsetTop;
        el.style.zIndex = 1000; el.style.transition = 'none';
      });
      window.addEventListener('mousemove', e => { if (!isDown) return; el.style.left = (e.clientX - offX) + 'px'; el.style.top = (e.clientY - offY) + 'px'; });
      window.addEventListener('mouseup', () => {
        if (isDown) {
          isDown = false;
          el.style.zIndex = '';
          el.style.transition = 'transform 0.1s';
          // Extract rotation from transform
          const match = el.style.transform.match(/rotate\((.*?)deg\)/);
          const r = match ? parseFloat(match[1]) : 0;
          // Ensure we keep the scale(0.3) when saving/updating position visually
          el.style.transform = `rotate(${r}deg) scale(0.3)`;
          updateCardPos(el.dataset.cardId, el.style.left, el.style.top, r);
        }
      });
    }

    function downloadCard(el) {
      // Clone to avoid modifying the visible card
      const clone = el.cloneNode(true);

      // Remove buttons from clone
      const del = clone.querySelector('.delete-btn');
      if (del) del.remove();
      const save = clone.querySelector('.save-btn');
      if (save) save.remove();

      // Create a container to hold the card for capturing
      // This container ensures the card is isolated and at 0,0
      const container = document.createElement('div');
      container.style.position = 'fixed';
      container.style.top = '0';
      container.style.left = '0';
      container.style.zIndex = '-9999';
      container.style.padding = '20px'; // Add padding for shadow
      container.style.background = 'transparent';

      // Reset card styles
      clone.style.position = 'relative'; // Inside container
      clone.style.transform = 'none';
      clone.style.margin = '0';
      clone.style.left = 'auto';
      clone.style.top = 'auto';

      container.appendChild(clone);
      document.body.appendChild(container);

      html2canvas(clone, {
        backgroundColor: null,
        scale: 3,
        logging: false,
        useCORS: true,
        scrollX: 0,
        scrollY: 0
      }).then(canvas => {
        const now = new Date();
        const ts = now.getFullYear() +
          (now.getMonth() + 1).toString().padStart(2, '0') +
          now.getDate().toString().padStart(2, '0') + '-' +
          now.getHours().toString().padStart(2, '0') +
          now.getMinutes().toString().padStart(2, '0');

        const link = document.createElement('a');
        link.download = `mood-card-${ts}.png`;
        link.href = canvas.toDataURL();
        link.click();
        document.body.removeChild(container);
      }).catch(err => {
        console.error('Download failed', err);
        alert('ä¸‹è¼‰å¤±æ•—');
        if (document.body.contains(container)) document.body.removeChild(container);
      });
    }

    /* API Integration */
    async function saveCard(meta) {
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(meta)
        });
      } catch (e) { console.error('Save failed', e); alert('å„²å­˜å¤±æ•—'); }
    }

    async function deleteCard(id) {
      try {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
      } catch (e) { console.error('Delete failed', e); }
    }

    async function updateCardPos(id, x, y, r) {
      try {
        await fetch(`${API_URL}/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            x: parseFloat(x),
            y: parseFloat(y),
            r: parseFloat(r)
          })
        });
      } catch (e) { console.error('Update pos failed', e); }
    }

    async function loadCards() {
      try {
        const res = await fetch(API_URL);
        const list = await res.json();
        list.forEach(d => {
          const el = document.createElement('div');
          el.className = `card ${d.style || 'polaroid'}`;
          el.dataset.cardId = d.id;
          el.style.left = d.x + 'px'; el.style.top = d.y + 'px';
          // Fix: Ensure r has a value and force scale(0.3)
          const r = d.r || 0;
          el.style.transform = `rotate(${r}deg) scale(0.3)`;

          let imgHtml = '';
          if (d.parts && d.header) { imgHtml = `<img src="${d.header}${d.parts.join('')}">`; }
          else { imgHtml = window.PRESET_SVGS[Math.floor(Math.random() * window.PRESET_SVGS.length)]; }

          const moodIcons = ['', 'ğŸ˜«', 'ğŸ™', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
          el.innerHTML = `
                <div class="delete-btn">Ã—</div>
                <div class="save-btn" title="ä¸‹è¼‰">â¬‡</div>
                <div class="photo">${imgHtml}</div>
                <div class="text">${d.text}</div>
                <div class="mood-badge">${moodIcons[d.mood] || ''}</div>
            `;
          cardsLayer.appendChild(el); bindCardEvents(el);
        });
      } catch (e) { console.error('Load failed', e); }
    }

    window.PRESET_SVGS = [
      `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#eef"><circle cx="50" cy="50" r="30" fill="#fbbf24"/></svg>`,
      `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#f0fdf4"><rect x="30" y="30" width="40" height="40" fill="#4ade80"/></svg>`,
      `<svg viewBox="0 0 100 100" style="width:100%;height:100%;background:#fff7ed"><polygon points="50,15 90,85 10,85" fill="#f87171"/></svg>`
    ];
  </script>
</body>

</html>